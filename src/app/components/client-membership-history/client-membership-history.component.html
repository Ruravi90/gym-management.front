<div *ngIf="loading" class="loading-state">
  <div class="loader"></div>
  <p>Cargando historial de membres√≠as...</p>
</div>

<div *ngIf="error" class="error-message">
  <span class="error-icon">‚ö†Ô∏è</span>
  <p>{{ error }}</p>
</div>

<div *ngIf="!loading && !error" class="history-content">
  <header class="main-header">
    <div class="header-info">
      <h1 class="page-title">Historial de Membres√≠as</h1>
      <p class="page-subtitle">{{ client?.name }} ‚Äî {{ client?.email }}</p>
    </div>
    <div class="header-actions">
      <button class="app-btn app-btn-secondary" (click)="loadData()">üîÑ Refrescar</button>
    </div>
  </header>

  <!-- Button to open membership registration modal -->
  <div class="section-header">
    <h3 class="section-title">Agregar Membres√≠a</h3>
    <button class="app-btn app-btn-primary" (click)="openNewMembershipModal()">
      <span>+</span> Nueva Membres√≠a
    </button>
  </div>

  <!-- Memberships List -->
  <div class="history-section">
    <div class="section-header">
      <h3 class="section-title">Historial de Membres√≠as</h3>
      <span class="count-badge">{{ memberships.length }} entradas</span>
    </div>

    <div *ngIf="memberships.length === 0" class="empty-state">
      <p>Este cliente a√∫n no tiene historial de membres√≠as.</p>
    </div>

    <!-- Table View for Desktop -->
    <div class="table-responsive-wrapper desktop-view">
      <table class="app-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Tipo</th>
            <th>Per√≠odo</th>
            <th>Precio</th>
            <th>Estado</th>
            <th>Pago</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let membership of memberships">
            <td>#{{ membership.id }}</td>
            <td>
              <span class="membership-badge" [attr.data-type]="membership.type">
                {{ membership.type | uppercase }}
              </span>
            </td>
            <td>
              <div class="date-range">
                <span>{{ formatDate(membership.start_date) }}</span>
                <span class="divider">‚Üí</span>
                <span>{{ formatDate(membership.end_date) }}</span>
              </div>
              <div class="time-left" *ngIf="isMembershipActive(membership)">
                <span class="days-count">{{ daysUntilExpiration(membership) }}</span> d√≠as restantes
              </div>
              <div class="time-left expired" *ngIf="isMembershipExpired(membership)">
                Venci√≥ hace {{ getDaysSinceExpiration(membership) }} d√≠as
              </div>
            </td>
            <td>${{ membership.price }}</td>
            <td>
              <span class="status-badge" [class]="membership.status">
                {{ membership.status | titlecase }}
              </span>
            </td>
            <td>
              <span class="payment-badge" [class]="membership.payment_status">
                {{ membership.payment_status | titlecase }}
              </span>
            </td>
            <td class="text-right">
              <div class="action-buttons">
                <button class="btn-action-icon edit" (click)="openEditModal(membership)" title="Editar">
                  ‚úèÔ∏è
                </button>
                <button class="btn-action-icon delete" (click)="deleteMembership(membership.id)" title="Eliminar">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Card View for Mobile -->
    <div class="cards-container mobile-view">
      <div class="membership-card" *ngFor="let membership of memberships">
        <div class="card-header">
          <div class="header-top">
            <div class="membership-id">#{{ membership.id }}</div>
            <span class="membership-badge" [attr.data-type]="membership.type">
              {{ membership.type | uppercase }}
            </span>
          </div>
          <div class="status-badge" [class]="membership.status">
            {{ membership.status | titlecase }}
          </div>
        </div>

        <div class="card-body">
          <div class="membership-details">
            <div class="detail-item">
              <span class="detail-label">Per√≠odo:</span>
              <span class="detail-value">{{ formatDate(membership.start_date) }} ‚Üí {{ formatDate(membership.end_date) }}</span>
            </div>
            <div class="detail-item" *ngIf="isMembershipActive(membership)">
              <span class="detail-label">Restante:</span>
              <span class="detail-value highlight-green">{{ daysUntilExpiration(membership) }} d√≠as</span>
            </div>
            <div class="detail-item" *ngIf="isMembershipExpired(membership)">
              <span class="detail-label">Expir√≥:</span>
              <span class="detail-value highlight-red">Hace {{ getDaysSinceExpiration(membership) }} d√≠as</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Precio:</span>
              <span class="detail-value">${{ membership.price }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Pago:</span>
              <span class="payment-badge" [class]="membership.payment_status">
                {{ membership.payment_status | titlecase }}
              </span>
            </div>
          </div>
        </div>

        <div class="card-actions">
          <button class="app-btn app-btn-secondary btn-sm" (click)="openEditModal(membership)">Editar</button>
          <button class="app-btn app-btn-danger btn-sm" (click)="deleteMembership(membership.id)">Eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Membership Registration Modal -->
  <div class="modal-backdrop" *ngIf="showMembershipModal">
    <div class="app-card modal-card">
      <div class="modal-header">
        <h3>{{ editingMembershipId ? 'Modificar Membres√≠a' : 'Nueva Alta de Membres√≠a' }}</h3>
        <button class="btn-close" (click)="closeMembershipModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="createMembership()" #membershipFormRef="ngForm" class="compact-form">
          <div class="form-grid">
            <div class="form-group">
              <label>Tipo de Plan</label>
              <select
                class="app-input"
                [(ngModel)]="newMembershipForm.membership_type_id"
                name="membership_type_id"
                (change)="onMembershipTypeChange()"
                required
                [disabled]="!!editingMembershipId"
              >
                <option value="">Seleccione un tipo...</option>
                <option *ngFor="let type of membershipTypes" [value]="type.id">
                  {{ type.name }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label>Importe ($)</label>
              <input
                type="number"
                class="app-input"
                [(ngModel)]="newMembershipForm.price_paid"
                name="price_paid"
                required
                min="0"
                step="0.01"
                readonly
                title="El importe se calcula autom√°ticamente seg√∫n el tipo de plan"
                [disabled]="!!editingMembershipId"
              />
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>Fecha de Inicio</label>
              <input
                type="date"
                class="app-input"
                [(ngModel)]="newMembershipForm.start_date"
                name="start_date"
                (change)="onStartDateChange()"
                required
                [disabled]="!!editingMembershipId"
              />
            </div>

            <div class="form-group">
              <label>Vencimiento</label>
              <input
                type="date"
                class="app-input"
                [(ngModel)]="newMembershipForm.end_date"
                name="end_date"
                required
                readonly
                title="El vencimiento se calcula autom√°ticamente seg√∫n la duraci√≥n del plan"
                [disabled]="!!editingMembershipId"
              />
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>Estado Administraci√≥n</label>
              <select
                class="app-input"
                [(ngModel)]="newMembershipForm.status"
                name="status"
                required
              >
                <option value="available">Disponible</option>
                <option value="active">Activa</option>
                <option value="expired">Expirada</option>
                <option value="suspended">Suspendida</option>
                <option value="cancelled">Cancelada</option>
              </select>
            </div>

            <div class="form-group">
              <label>Estado del Pago</label>
              <select
                class="app-input"
                [(ngModel)]="newMembershipForm.payment_status"
                name="payment_status"
                required
              >
                <option value="pending">Pendiente</option>
                <option value="paid">Pagado</option>
                <option value="overdue">Atrasado</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>M√©todo de Pago</label>
            <select
              class="app-input"
              [(ngModel)]="newMembershipForm.payment_method"
              name="payment_method"
            >
              <option value="">Seleccione m√©todo...</option>
              <option value="cash">Efectivo</option>
              <option value="card">Tarjeta</option>
              <option value="bank_transfer">Transferencia bancaria</option>
              <option value="online">Pago en l√≠nea</option>
            </select>
          </div>

          <div class="form-group">
            <label>Notas Adicionales</label>
            <textarea
              class="app-input"
              [(ngModel)]="newMembershipForm.notes"
              name="notes"
              rows="3"
            ></textarea>
          </div>

          <div class="modal-actions">
            <button type="button" class="app-btn app-btn-secondary" (click)="closeMembershipModal()">
              Cancelar
            </button>
            <button type="submit" class="app-btn app-btn-primary" [disabled]="!membershipFormRef.form.valid">
              Confirmar Registro
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>