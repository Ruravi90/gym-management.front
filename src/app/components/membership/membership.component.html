<header class="main-header">
  <div class="header-info">
    <h1 class="page-title">Administraci√≥n de Membres√≠as</h1>
    <p class="page-subtitle">Control total sobre los planes de tus guerreros</p>
  </div>
  <div class="header-actions">
    <button class="app-btn app-btn-primary" (click)="openNewMembershipModal()">
      <span>+</span> Nueva Membres√≠a
    </button>
  </div>
</header>

<!-- Collapsible Filters Area -->
<div class="app-card filters-container">
  <div class="filters-header" (click)="toggleFilters()">
    <h3>Filtros Avanzados</h3>
    <span class="filter-toggle">{{ showFilters ? '‚ñ≤' : '‚ñº' }}</span>
  </div>
  <div class="filters-content" [class.expanded]="showFilters">
    <div class="filters-grid">
      <div class="form-group">
        <label>Estado del Plan</label>
        <select
          class="app-input"
          [(ngModel)]="filters.status"
          (change)="applyFilters()"
        >
          <option value="">Cualquier estado</option>
          <option value="available">Disponible</option>
          <option value="active">Activa</option>
          <option value="expired">Expirada</option>
          <option value="suspended">Suspendida</option>
          <option value="cancelled">Cancelada</option>
        </select>
      </div>

      <div class="form-group">
        <label>Estado de Pago</label>
        <select
          class="app-input"
          [(ngModel)]="filters.paymentStatus"
          (change)="applyFilters()"
        >
          <option value="">Cualquier pago</option>
          <option value="paid">Pagado</option>
          <option value="pending">Pendiente</option>
          <option value="overdue">Atrasado</option>
        </select>
      </div>

      <div class="form-group search-group">
        <label>Socio</label>
        <select
          class="app-input"
          [(ngModel)]="filters.clientId"
          (change)="applyFilters()"
        >
          <option value="">Todos los clientes</option>
          <option *ngFor="let client of clients" [value]="client.id">
            {{ client.name }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>Tipo de Membres√≠a</label>
        <select
          class="app-input"
          [(ngModel)]="filters.membershipTypeId"
          (change)="applyFilters()"
        >
          <option value="">Todos los tipos</option>
          <option *ngFor="let type of membershipTypes" [value]="type.id">
            {{ type.name }}
          </option>
        </select>
      </div>

      <div class="filter-actions">
        <button class="app-btn app-btn-secondary" (click)="clearFilters()">
          Limpiar Filtros
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Table View for Desktop -->
<div class="table-responsive-wrapper desktop-view">
  <table class="app-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Guerrero / Socio</th>
        <th>Tipo de Plan</th>
        <th>Detalles</th>
        <th>Vigencia</th>
        <th>Estado</th>
        <th class="text-center">Pagos</th>
        <th class="text-right">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let membership of memberships">
        <td class="id-cell">#{{ membership.id }}</td>
        <td>
          <div
            class="client-link"
            (click)="viewClientHistory(membership.client_id)"
          >
            {{ getClientName(membership.client_id) }}
          </div>
        </td>
        <td>
          <span
            class="membership-badge"
            [attr.data-type]="
              getMembershipTypeName(membership.membership_type_id)
            "
          >
            {{ getMembershipTypeName(membership.membership_type_id) }}
          </span>
        </td>
        <td>
          <div class="membership-details">
            <div class="detail-item">
              <strong>Precio:</strong> ${{
                membership.price_paid || membership.price
              }}
            </div>
            <div
              class="detail-item"
              *ngIf="membership.accesses_used !== undefined"
            >
              <strong>Accesos:</strong> {{ getAccessesRemaining(membership) }}
            </div>
          </div>
        </td>
        <td>
          <div class="date-range">
            <span class="date">{{ formatDate(membership.start_date) }}</span>
            <span class="divider">‚Üí</span>
            <span class="date bold">{{ formatDate(membership.end_date) }}</span>
          </div>
          <div class="time-left" *ngIf="!isMembershipExpired(membership)">
            <span class="days-count">{{
              daysUntilExpiration(membership)
            }}</span>
            d√≠as restantes
          </div>
          <div
            class="time-left expired"
            *ngIf="isMembershipExpired(membership)"
          >
            Expir√≥ hace {{ -daysUntilExpiration(membership) }} d√≠as
          </div>
        </td>
        <td>
          <span
            class="status-badge"
            [style.color]="getStatusColor(membership.status)"
            [style.background]="getStatusColor(membership.status) + '15'"
          >
            {{ membership.status | titlecase }}
          </span>
        </td>
        <td class="text-center">
          <span class="payment-badge" [class]="membership.payment_status">
            {{ membership.payment_status | titlecase }}
          </span>
        </td>
        <td class="text-right">
          <div class="action-buttons">
            <button
              class="btn-action-icon edit"
              (click)="openEditModal(membership)"
            >
              ‚úèÔ∏è
            </button>
            <button
              class="btn-action-icon delete"
              (click)="deleteMembership(membership.id)"
            >
              üóëÔ∏è
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Card View for Mobile -->
<div class="cards-container mobile-view" *ngIf="paginatedMemberships.length > 0">
  <div class="membership-card" *ngFor="let membership of paginatedMemberships">
    <div class="card-header">
      <div class="header-top">
        <div class="membership-id">#{{ membership.id }}</div>
        <div class="client-name">{{ getClientName(membership.client_id) }}</div>
      </div>
      <div class="header-tags">
        <span
          class="membership-badge"
          [attr.data-type]="getMembershipTypeName(membership.membership_type_id)"
        >
          {{ getMembershipTypeName(membership.membership_type_id) }}
        </span>
        <span
          class="status-badge"
          [style.color]="getStatusColor(membership.status)"
          [style.background]="getStatusColor(membership.status) + '15'"
        >
          {{ membership.status | titlecase }}
        </span>
      </div>
    </div>

    <div class="card-body">
      <div class="membership-details-grid">
        <div class="detail-item">
          <span class="detail-label">Precio:</span>
          <span class="detail-value">${{ membership.price_paid || membership.price }}</span>
        </div>
        <div class="detail-item" *ngIf="membership.accesses_used !== undefined">
          <span class="detail-label">Accesos:</span>
          <span class="detail-value">{{ getAccessesRemaining(membership) }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Inicio:</span>
          <span class="detail-value">{{ formatDate(membership.start_date) }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Fin:</span>
          <span class="detail-value">{{ formatDate(membership.end_date) }}</span>
        </div>
        <div class="detail-item" *ngIf="!isMembershipExpired(membership)">
          <span class="detail-label">Restante:</span>
          <div class="time-left">
            <span class="days-count">{{ daysUntilExpiration(membership) }}</span>
            d√≠as
          </div>
        </div>
        <div class="detail-item" *ngIf="isMembershipExpired(membership)">
          <span class="detail-label">Expir√≥:</span>
          <div class="time-left expired">
            Hace {{ -daysUntilExpiration(membership) }} d√≠as
          </div>
        </div>
        <div class="detail-item">
          <span class="detail-label">Pago:</span>
          <span class="payment-badge" [class]="membership.payment_status">
            {{ membership.payment_status | titlecase }}
          </span>
        </div>
      </div>
    </div>

    <div class="card-actions">
      <button class="app-btn app-btn-secondary btn-sm" (click)="openEditModal(membership)">Editar</button>
      <button class="app-btn app-btn-danger btn-sm" (click)="deleteMembership(membership.id)">Eliminar</button>
    </div>
  </div>
</div>

<!-- Empty state for mobile -->
<div class="empty-state mobile-view" *ngIf="paginatedMemberships.length === 0 && memberships.length > 0">
  <p>No se encontraron membres√≠as en esta p√°gina</p>
</div>

<div class="empty-state mobile-view" *ngIf="memberships.length === 0">
  <p>No se encontraron membres√≠as</p>
</div>

<!-- Pagination Controls for Mobile -->
<div class="pagination-controls mobile-view" *ngIf="totalPages > 1">
  <div class="pagination-info">
    P√°gina {{currentPage}} de {{totalPages}}
  </div>
  <div class="pagination-buttons">
    <button class="app-btn app-btn-secondary btn-sm"
            [disabled]="currentPage === 1"
            (click)="prevPage()">
      Anterior
    </button>
    <span class="page-numbers">
      <button *ngFor="let page of getPageNumbers()"
              class="app-btn btn-sm"
              [class.app-btn-primary]="page === currentPage"
              [class.app-btn-secondary]="page !== currentPage"
              (click)="goToPage(page)">
        {{page}}
      </button>
    </span>
    <button class="app-btn app-btn-secondary btn-sm"
            [disabled]="currentPage === totalPages"
            (click)="nextPage()">
      Siguiente
    </button>
  </div>
</div>

<!-- Unified Premium Modal -->
<div class="modal-backdrop" *ngIf="showMembershipModal">
  <div class="app-card modal-card">
    <div class="modal-header">
      <h3>
        {{
          editingMembership ? "Modificar Membres√≠a" : "Nueva Alta de Membres√≠a"
        }}
      </h3>
      <button class="btn-close" (click)="closeMembershipModal()">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <form
        (ngSubmit)="saveMembership()"
        #membershipFormRef="ngForm"
        class="compact-form"
      >
        <div class="form-group">
          <label>Selecci√≥n de Cliente</label>
          <select
            class="app-input"
            [(ngModel)]="membershipForm.client_id"
            name="client_id"
            required
            [disabled]="!!editingMembership"
          >
            <option value="">Seleccione un socio...</option>
            <option *ngFor="let client of clients" [value]="client.id">
              {{ client.name }}
            </option>
          </select>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Tipo de Plan</label>
            <select
              class="app-input"
              [(ngModel)]="membershipForm.membership_type_id"
              name="membership_type_id"
              (change)="onMembershipTypeChange()"
              [disabled]="!!editingMembership"
            >
              <option value="">Seleccione un tipo...</option>
              <option *ngFor="let type of membershipTypes" [value]="type.id">
                {{ type.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>Importe ($)</label>
            <input
              type="number"
              class="app-input"
              [(ngModel)]="membershipForm.price_paid"
              name="price_paid"
              required
              min="0"
              step="0.01"
              readonly
              title="El importe se calcula autom√°ticamente seg√∫n el tipo de plan"
            />
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Fecha de Inicio</label>
            <input
              type="date"
              class="app-input"
              [(ngModel)]="membershipForm.start_date"
              name="start_date"
              (change)="onStartDateChange()"
              required
              [disabled]="!!editingMembership"
/>
          </div>

          <div class="form-group">
            <label>Vencimiento</label>
            <input
              type="date"
              class="app-input"
              [(ngModel)]="membershipForm.end_date"
              name="end_date"
              required
              readonly
              [disabled]="!!editingMembership"
              title="El vencimiento se calcula autom√°ticamente seg√∫n la duraci√≥n del plan"
            />

          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Estado Administraci√≥n</label>
            <select
              class="app-input"
              [(ngModel)]="membershipForm.status"
              name="status"
              required
            >
              <option value="available">Disponible</option>
              <option value="active">Activa</option>
              <option value="expired">Expirada</option>
              <option value="suspended">Suspendida</option>
              <option value="cancelled">Cancelada</option>
            </select>
          </div>

          <div class="form-group">
            <label>Estado del Pago</label>
            <select
              class="app-input"
              [(ngModel)]="membershipForm.payment_status"
              name="payment_status"
              required
            >
              <option value="pending">Pendiente</option>
              <option value="paid">Pagado</option>
              <option value="overdue">Atrasado</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>M√©todo de Pago</label>
          <select
            class="app-input"
            [(ngModel)]="membershipForm.payment_method"
            name="payment_method"
          >
            <option value="">Seleccione m√©todo...</option>
            <option value="cash">Efectivo</option>
            <option value="card">Tarjeta</option>
            <option value="bank_transfer">Transferencia bancaria</option>
            <option value="online">Pago en l√≠nea</option>
          </select>
        </div>

        <div class="form-group">
          <label>Notas Adicionales</label>
          <textarea
            class="app-input"
            [(ngModel)]="membershipForm.notes"
            name="notes"
            rows="3"
          ></textarea>
        </div>

        <div class="modal-actions">
          <button
            type="button"
            class="app-btn app-btn-secondary"
            (click)="closeMembershipModal()"
          >
            Descartar
          </button>
          <button
            type="submit"
            class="app-btn app-btn-primary"
            [disabled]="!membershipFormRef.form.valid"
          >
            {{
              editingMembership ? "Actualizar Cambios" : "Confirmar Registro"
            }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
